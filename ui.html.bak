<!DOCTYPE html>
<html lang="ko">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' 'unsafe-inline' data:; connect-src 'self' https://docs.google.com https://*.google.com https://static.figma.com https://*.googleusercontent.com; font-src 'self' https://static.figma.com data:;" />
  <title>ë©”ë‰´ ì•„ì´ì½˜ ì œì•ˆ</title>
  <style>
    :root {
      --font-family-default: "Inter", ui-sans-serif, -apple-system,
        BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
        sans-serif;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --radius-small: 6px;
      --radius-medium: 10px;
      --line-height-default: 1.4;
      --font-size-default: 13px;
      --letter-spacing-default: 0;
      --font-weight-default: 500;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-family-default);
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: var(--space-4);
      gap: var(--space-4);
    }

    .fp-panel {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: var(--radius-medium);
      padding: var(--space-4);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
    }

    .fp-section {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .fp-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--figma-color-text);
    }

    .fp-sub {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      margin: 0;
    }

    .fp-label {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      font-weight: 600;
    }

    .fp-Input {
      all: unset;
      box-sizing: border-box;
      width: 100%;
      height: var(--space-6);
      padding: var(--space-1) 0 var(--space-1) var(--space-2);
      background-color: var(--figma-color-bg);
      border-radius: var(--radius-medium);
      font-family: var(--font-family-default);
      font-size: var(--font-size-default);
      font-weight: var(--font-weight-default);
      letter-spacing: var(--letter-spacing-default);
      line-height: var(--line-height-default);
      color: var(--figma-color-text);
      outline-width: 1px;
      outline-style: solid;
      outline-offset: -1px;
      outline-color: var(--figma-color-border);
    }

    .fp-Input:hover {
      outline-color: var(--figma-color-border-selected);
    }

    .fp-Input:focus {
      outline-color: var(--figma-color-border-selected-strong);
    }

    .fp-Input::placeholder {
      color: var(--figma-color-text-tertiary);
    }

    .fp-Button {
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-small);
      font-family: var(--font-family-default);
      font-size: 12px;
      font-weight: 600;
      line-height: 1.2;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      outline: 1px solid transparent;
      transition: background 120ms ease, outline-color 120ms ease,
        opacity 120ms ease;
    }

    .fp-Button:hover {
      background: var(--figma-color-bg-brand-pressed);
    }

    .fp-Button:active {
      background: var(--figma-color-bg-pressed);
    }

    .fp-Button:focus-visible {
      outline-color: var(--figma-color-border-selected);
    }

    .fp-Button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .fp-Button.secondary {
      background: transparent;
      color: var(--figma-color-text);
      outline-color: var(--figma-color-border);
    }

    .fp-Button.secondary:hover {
      background: var(--figma-color-bg-hover);
    }

    .fp-stack {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .fp-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .fp-card {
      border: 1px solid var(--figma-color-border);
      border-radius: var(--radius-medium);
      padding: var(--space-3);
      background-color: var(--figma-color-bg);
    }

    .fp-status {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    .fp-json {
      background-color: var(--figma-color-bg-tertiary);
      border: 1px solid var(--figma-color-border);
      border-radius: var(--radius-medium);
      padding: var(--space-3);
      color: var(--figma-color-text-secondary);
      font-family: "Roboto Mono", monospace;
      font-size: 12px;
      max-height: 220px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .fp-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 8px;
      background-color: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      font-size: 11px;
      font-weight: 600;
    }

    .fp-divider {
      height: 1px;
      background: var(--figma-color-border);
      margin: var(--space-2) 0;
    }

    /* íƒ­ UI ìŠ¤íƒ€ì¼ */
    .fp-tab-nav {
      display: flex;
      gap: var(--space-1);
      border-bottom: 1px solid var(--figma-color-border);
      padding-bottom: var(--space-1);
      margin-bottom: var(--space-2);
    }

    .fp-tab-button {
      flex: 1;
      padding: var(--space-2);
      background: none;
      border: none;
      border-radius: var(--radius-small);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: var(--figma-color-text-secondary);
      transition: all 0.2s;
    }

    .fp-tab-button:hover {
      background-color: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .fp-tab-button.active {
      background-color: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
    }

    .tab-content {
      display: none;
      flex-direction: column;
      gap: var(--space-4);
      /* ìŠ¤í¬ë¡¤ ê°œì„  */
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ */
    }

    .tab-content.active {
      display: flex;
    }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ ìŠ¤í¬ë¡¤ ì¡°ì • */
    body {
      overflow: hidden;
      /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }

    .fp-panel {
      height: 100%;
      overflow: hidden;
      /* íŒ¨ë„ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œì–´ */
      padding-right: var(--space-2);
      /* ìš°ì¸¡ ì—¬ë°± í™•ë³´ */
    }
  </style>
</head>

<body>
  <div class="fp-panel">
    <!-- íƒ­ ë‚´ë¹„ê²Œì´ì…˜ -->
    <div class="fp-tab-nav">
      <button id="tabBtnMapping" class="fp-tab-button active">ğŸ” ì•„ì´ì½˜ ë§¤í•‘</button>
      <button id="tabBtnManagement" class="fp-tab-button">ğŸ†• ì—ì…‹ ê´€ë¦¬</button>
    </div>

    <!-- íƒ­ 1: ì•„ì´ì½˜ ë§¤í•‘ -->
    <div id="tab-mapping" class="tab-content active">
      <header class="fp-section">
        <div class="fp-row" style="justify-content: space-between">
          <h1 class="fp-title">ì•„ì´ì½˜ í•˜ì´ ë§¤í•‘ ì œì•ˆ</h1>
          <span class="fp-tag">ë¡œì»¬ ë§¤í•‘ DB</span>
        </div>
        <p class="fp-sub">ë©”ë‰´ëª… ê¸°ë°˜ìœ¼ë¡œ ì•„ì´ì½˜ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
      </header>

      <section class="fp-section">
        <label for="menuName" class="fp-label">ë©”ë‰´ëª… ì…ë ¥ (ì˜ˆ: ì¬ê³ ë¬¼í’ˆê´€ë¦¬, í‡´ì›í™˜ìë³„í†µê³„)</label>
        <input type="text" id="menuName" value="ì¬ê³ ë¬¼í’ˆê´€ë¦¬" class="fp-Input" placeholder="ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <div class="fp-row" style="justify-content: flex-end">
          <button id="suggestButton" class="fp-Button" style="width: 100%">
            ì•„ì´ì½˜ ì œì•ˆ ë°›ê¸°
          </button>
        </div>
      </section>

      <div id="loadingIndicator" class="fp-status" style="display: none">
        ë¡œì»¬ ë§¤í•‘ ì¤‘...
      </div>

      <section class="fp-section fp-card">
        <div class="fp-row" style="justify-content: space-between; align-items: center">
          <span class="fp-label">ê²°ê³¼ ìš”ì•½</span>
          <span class="fp-status">ë§¤ì¹­/ì¡°í•©/ë¯¸ì •ì˜ í‚¤ì›Œë“œ í”¼ë“œë°±</span>
        </div>
        <div id="keywordFeedback" class="fp-stack"></div>
        <div class="fp-divider"></div>
        <span class="fp-label">Raw JSON</span>
        <pre id="resultsPre" class="fp-json">ëŒ€ê¸° ì¤‘...</pre>
      </section>

    </div> <!-- /tab-mapping -->

    <!-- íƒ­ 2: ì—ì…‹ ê´€ë¦¬ -->
    <div id="tab-management" class="tab-content">
      <!-- ì—ì…‹ ë“±ë¡ ì„¹ì…˜ -->
      <section class="fp-section fp-card" style="margin-top: var(--space-4);">
        <div class="fp-row" style="justify-content: space-between; align-items: center;">
          <span class="fp-label">ğŸ†• ì—ì…‹ ë“±ë¡</span>
        </div>

        <div id="registerForm" style="margin-top: var(--space-3);">
          <div class="fp-stack">
            <div>
              <label class="fp-label">í‚¤ì›Œë“œ *</label>
              <input type="text" id="regKeyword" class="fp-Input" placeholder="ì˜ˆ: ê²€ìƒ‰" />
            </div>

            <div>
              <label class="fp-label">ì„¤ëª…</label>
              <input type="text" id="regDescription" class="fp-Input" placeholder="ì˜ˆ: ë°ì´í„° ê²€ìƒ‰ ê´€ë ¨ ì•„ì´ì½˜" />
            </div>

            <div>
              <label class="fp-label">ì»¨ì…‰/ìœ ì˜ì–´ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
              <input type="text" id="regConcept" class="fp-Input" placeholder="ì˜ˆ: ì°¾ê¸°, ì¡°íšŒ, íƒìƒ‰" />
            </div>

            <div>
              <label class="fp-label">Component Set *</label>
              <div class="fp-row">
                <button id="selectComponentSet" class="fp-Button secondary" style="flex: 1;">
                  Figmaì—ì„œ ì„ íƒí•œ Component Set ê°€ì ¸ì˜¤ê¸°
                </button>
              </div>
              <input type="text" id="regComponentSetName" class="fp-Input" placeholder="Component Set ì´ë¦„" readonly
                style="margin-top: 4px;" />
              <input type="text" id="regComponentSetKey" class="fp-Input" placeholder="Component Set Key" readonly
                style="margin-top: 4px; font-family: 'Roboto Mono', monospace; font-size: 11px;" />
            </div>

            <div>
              <label class="fp-label">Variant ì†ì„± ì„ íƒ *</label>
              <!-- ì²´í¬ë°•ìŠ¤ ëª©ë¡ì´ ë“¤ì–´ê°ˆ ì»¨í…Œì´ë„ˆ -->
              <div id="variantList" class="fp-stack" style="
                max-height: 120px; 
                overflow-y: auto; 
                border: 1px solid var(--figma-color-border); 
                border-radius: var(--radius-small); 
                padding: 8px;
                background: var(--figma-color-bg-secondary);
              ">
                <span class="fp-sub" style="color: var(--figma-color-text-tertiary);">
                  ìœ„ì—ì„œ 'ê°€ì ¸ì˜¤ê¸°'ë¥¼ í•˜ë©´ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </span>
              </div>
            </div>

            <button id="registerAssetBtn" class="fp-Button" style="width: 100%;">
              âœ… ì—ì…‹ ë“±ë¡
            </button>
          </div>
        </div>
      </section>

      <!-- ë°ì´í„° ê´€ë¦¬ ì„¹ì…˜ ì œê±°ë¨ (ì‚¬ìš©ì í¸ì˜ì„± ì¦ëŒ€) -->
      <!-- <section class="fp-section fp-card" ...> ... </section> -->

      <!-- ğŸ”„ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ì„¹ì…˜ -->
      <section class="fp-section fp-card" style="margin-top: var(--space-4);">
        <div class="fp-row" style="justify-content: space-between; align-items: center;">
          <span class="fp-label">ğŸ”„ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”</span>
          <span id="syncStatus" class="fp-status" style="font-weight: 600;">ëŒ€ê¸° ì¤‘</span>
        </div>
        <div id="syncInfo" class="fp-sub" style="margin-top: 8px; display: flex; gap: 12px;">
          <span>ë§ˆì§€ë§‰ ë™ê¸°í™”: <strong id="lastSyncTime">-</strong></span>
          <span>|</span>
          <span>ì—ì…‹: <strong id="assetCount">0</strong>ê°œ</span>
        </div>
        <button id="syncNowBtn" class="fp-Button secondary" style="width: 100%; margin-top: 12px;">
          ğŸ”„ ì§€ê¸ˆ ë™ê¸°í™”
        </button>
      </section>
    </div> <!-- /tab-management -->
  </div> <!-- /fp-panel -->

  <script>
    // íƒ­ ì „í™˜ ë¡œì§
    const tabs = {
      mapping: { btn: document.getElementById('tabBtnMapping'), content: document.getElementById('tab-mapping') },
      management: { btn: document.getElementById('tabBtnManagement'), content: document.getElementById('tab-management') }
    };

    function switchTab(target) {
      // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
      Object.values(tabs).forEach(tab => {
        tab.btn.classList.remove('active');
        tab.content.classList.remove('active');
      });

      // ëŒ€ìƒ íƒ­ í™œì„±í™”
      tabs[target].btn.classList.add('active');
      tabs[target].content.classList.add('active');

      // íƒ­ ì „í™˜ ì‹œ ìë™ í¬ì»¤ìŠ¤ ì œê±° (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
      // if (target === 'management') {
      //   setTimeout(() => {
      //     const firstInput = document.getElementById('regKeyword');
      //     if (firstInput) firstInput.focus();
      //   }, 100);
      // } else if (target === 'mapping') {
      //   setTimeout(() => {
      //     const menuInput = document.getElementById('menuName');
      //     if (menuInput) menuInput.focus();
      //   }, 100);
      // }
    }

    tabs.mapping.btn.onclick = () => switchTab('mapping');
    tabs.management.btn.onclick = () => switchTab('management');

    const suggestButton = document.getElementById("suggestButton");
    const keywordFeedback = document.getElementById("keywordFeedback");
    const menuNameInput = document.getElementById("menuName");

    function triggerSuggest() {
      const menuName = menuNameInput.value;
      const loading = document.getElementById("loadingIndicator");
      const resultsPre = document.getElementById("resultsPre");

      if (!menuName) return;

      suggestButton.disabled = true;
      loading.style.display = "block";
      resultsPre.textContent = "ë¶„ì„ ìš”ì²­ ì¤‘...";
      keywordFeedback.innerHTML = "";

      // 1. Figma Plugin (code.ts)ìœ¼ë¡œ ë©”ë‰´ëª… ì „ì†¡
      parent.postMessage(
        { pluginMessage: { type: "suggest-icons", menuName } },
        "*"
      );
    }

    suggestButton.onclick = triggerSuggest;

    // ì—”í„° í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
    menuNameInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !suggestButton.disabled) {
        event.preventDefault();
        triggerSuggest();
      }
    });

    // 4. Figma Plugin (code.ts)ì—ì„œ ê²°ê³¼ ìˆ˜ì‹ 
    function renderKeywordFeedback(result) {
      const {
        input_keywords = [],
        match_details = [],
        asset_combinations = [],
        missing_keywords = [],
        missing_keyword_suggestions = [],
      } = result;

      // Helper for styling
      const primaryText = `color: var(--figma-color-text); font-weight: 600;`;
      const tertiaryText = `color: var(--figma-color-text-tertiary);`;
      const brandText = `color: var(--figma-color-text-brand);`;
      const dangerText = `color: var(--figma-color-text-danger); font-weight: 600;`;
      const secondaryText = `color: var(--figma-color-text-secondary);`;
      const monoFont = `font-family: 'Roboto Mono', monospace;`;

      const inputSummary = input_keywords.length
        ? `<div><span style="${primaryText}">ì…ë ¥ í‚¤ì›Œë“œ:</span> ${input_keywords.join(
          ", "
        )}</div>`
        : `<div style="${tertiaryText}">ì…ë ¥ê³¼ ì§ì ‘ ì¼ì¹˜í•˜ëŠ” í‚¤ì›Œë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;

      const detailSummary = match_details.length
        ? `<ul style="list-style-position: inside; padding-left: 0; margin: 0; display: flex; flex-direction: column; gap: 4px;">
                        ${match_details
          .map((detail) => {
            const labelMap = {
              exact: "ì§ì ‘ ì¼ì¹˜",
              concept: "ê°œë… ë§¤ì¹­",
              synonym: "ìœ ì‚¬ì–´ ë§¤í•‘",
            };
            const inputToken =
              detail.inputToken ?? "ì§ì ‘ ì¼ì¹˜ ì—†ìŒ";
            return `<li><span style="${monoFont} ${brandText}">${inputToken}</span> â†’ <span style="font-weight: 600;">${detail.matchedKeyword
              }</span> <span style="font-size: 11px; ${tertiaryText}">(${labelMap[detail.matchType]
              } Â· ìœ ì‚¬ë„ ${detail.similarity})</span></li>`;
          })
          .join("")}
                   </ul>`
        : `<div style="${tertiaryText}">ë§¤ì¹­ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì•„ì´ì½˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>`;

      const combinationSummary = asset_combinations.length
        ? `<div style="padding-top: 12px;"><span style="${primaryText}">ì¡°í•© ì œì•ˆ (${asset_combinations.length
        }ê°œ)</span>
                        <ol style="list-style-position: inside; padding-left: 0; margin: 8px 0 0 0; color: var(--figma-color-text-brand); font-size: 12px; display: flex; flex-direction: column; gap: 4px;">
                            ${asset_combinations
          .map(
            (combo, index) =>
              `<li>Option ${index + 1}: ${combo.join(
                " + "
              )}</li>`
          )
          .join("")}
                        </ol>
                   </div>`
        : `<div style="padding-top: 12px; ${tertiaryText}">ìƒì„±ëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

      const missingSummary = missing_keywords.length
        ? `<div style="padding-top: 12px; margin-top: 12px; border-top: 1px solid var(--figma-color-border);">
                        <span style="${dangerText}">ì‹ ê·œ í‚¤ì›Œë“œ/ë©”íƒ€í¬ í•„ìš”</span>
                        <ul style="list-style-position: inside; padding-left: 0; margin: 8px 0 0 0; font-size: 12px; ${secondaryText}; display: flex; flex-direction: column; gap: 4px;">
                            ${missing_keyword_suggestions
          .map((item) => {
            const related = item.related_keywords?.length
              ? item.related_keywords
                .map(
                  (r) =>
                    `${r.keyword} (ìœ ì‚¬ë„ ${r.similarity})`
                )
                .join(", ")
              : "ì—°ê´€ í‚¤ì›Œë“œ ì œì•ˆ ì—†ìŒ";
            return `<li><span style="${monoFont} color: var(--figma-color-text);">${item.missing}</span> â†’ ë©”íƒ€í¬ ì œì‘ í•„ìš” <span style="font-size: 11px; ${tertiaryText}">(${related})</span></li>`;
          })
          .join("")}
                        </ul>
                   </div>`
        : `<div style="padding-top: 12px; ${tertiaryText}">ë¯¸ì •ì˜ í‚¤ì›Œë“œ ì—†ì´ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;

      keywordFeedback.innerHTML = `${inputSummary}<div style="padding-top: 8px;">${detailSummary}</div>${combinationSummary}${missingSummary}`;
    }

    // -----------------------------------------------------------
    // ğŸ†• ì—ì…‹ ë“±ë¡ ë° ë°ì´í„° ê´€ë¦¬ ë¡œì§
    // -----------------------------------------------------------

    // -----------------------------------------------------------
    // ğŸ†• ì—ì…‹ ë“±ë¡ ë° ë°ì´í„° ê´€ë¦¬ ë¡œì§
    // -----------------------------------------------------------

    // ğŸ”´ [CONFIG] Google Apps Script Web App URL
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx3KzEebGPoZyVIOdjJeoZ7pyuP4cvedez9TWOauwe9U1fLsfCMhAZvKEAmvaEhAdDj/exec";

    // Component Set ì„ íƒ
    document.getElementById('selectComponentSet').onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'get-selected-component-set' } }, '*');
    };

    // ì—ì…‹ ë“±ë¡
    document.getElementById('registerAssetBtn').onclick = () => {
      const keyword = document.getElementById('regKeyword').value.trim();
      const description = document.getElementById('regDescription').value.trim();
      const concept = document.getElementById('regConcept').value.trim();
      const componentSetName = document.getElementById('regComponentSetName').value.trim();
      const componentSetKey = document.getElementById('regComponentSetKey').value.trim();

      // ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒëœ Variants ìˆ˜ì§‘
      const checkboxes = document.querySelectorAll('#variantList input[type="checkbox"]:checked');
      const selectedVariants = Array.from(checkboxes).map(box => JSON.parse(box.dataset.variant));

      if (!keyword || !componentSetName || !componentSetKey) {
        alert('í•„ìˆ˜ í•­ëª©(í‚¤ì›Œë“œ, Component Set)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (selectedVariants.length === 0) {
        alert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ Variant ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const registerBtn = document.getElementById('registerAssetBtn');
      const originalBtnText = registerBtn.textContent;
      registerBtn.textContent = 'ë“±ë¡ ì¤‘... â³';
      registerBtn.disabled = true;

      // GASë¡œ ì „ì†¡ (ë¹„ë™ê¸°)
      fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        body: JSON.stringify({ keyword, description, concept, componentSetKey, componentSetName, variants: selectedVariants })
      })
        .then(res => res.json())
        .then(result => {
          if (result.result === 'success') {
            alert(`âœ… ë“±ë¡ ì„±ê³µ!\n\n"${keyword}" ì—ì…‹ì´ êµ¬ê¸€ ì‹œíŠ¸ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\ní”ŒëŸ¬ê·¸ì¸ ë°ì´í„°ë„ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.`);

            // ì…ë ¥í¼ ì´ˆê¸°í™”
            document.getElementById('regKeyword').value = '';
            document.getElementById('regDescription').value = '';
            document.getElementById('regConcept').value = '';

            // ìë™ ë™ê¸°í™” íŠ¸ë¦¬ê±°
            return syncWithGas(true); // silent mode
          } else {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${result.message}`);
          }
        })
        .then(() => {
          registerBtn.textContent = originalBtnText;
          registerBtn.disabled = false;
        })
        .catch(err => {
          console.error(err);
          // ì‹¤íŒ¨ ë¡œì§
          alert(`âŒ ë“±ë¡ ì‹¤íŒ¨\n\nì˜¤ë¥˜ ë‚´ìš©: ${err.message}\n\n[í•´ê²° ë°©ë²•]\n1. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n2. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.\n(ë¡œì»¬ ë°ì´í„°ì—ëŠ” ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)`);

          registerBtn.textContent = originalBtnText;
          registerBtn.disabled = false;

          // ë¡œì»¬ ì €ì¥ ë°±ì—… (ì„ íƒì‚¬í•­ - ì‚¬ìš©ìê°€ ì›ì¹˜ ì•Šìœ¼ë©´ ì œê±° ê°€ëŠ¥í•˜ì§€ë§Œ, ì•ˆì „ì„ ìœ„í•´ ìœ ì§€í•˜ê±°ë‚˜ í”Œë˜ê·¸ ì²˜ë¦¬)
          // ì—¬ê¸°ì„œëŠ” 'Fail safe'ë¡œ ë‚¨ê²¨ë‘ë˜ ê²½ê³  ë©”ì‹œì§€ì—ì„œ "ë¡œì»¬ì—” ì €ì¥ ì•ˆë¨" ì´ë¼ê³  í–ˆìœ¼ë¯€ë¡œ 
          // ì•„ë˜ postMessageëŠ” ì œê±°í•˜ëŠ”ê²Œ ë§ìŒ. ì‚¬ìš©ìê°€ "ë°ì´í„° ê´€ë¦¬ í•„ìš”ì—†ë‹¤"ê³  í–ˆìœ¼ë¯€ë¡œ.
        });
    };

    // ì´ˆê¸°í™” ì‹œ ìë™ ë™ê¸°í™”
    window.onload = () => {
      syncWithGas(true);

      // ğŸš¨ CRITICAL FIX: Force focus redirection to iframe to fix typing block issue
      setTimeout(() => {
        window.focus(); // 1. iframe ìœˆë„ìš° ìì²´ì— í¬ì»¤ìŠ¤ (Figmaë¡œë¶€í„° í‚¤ë³´ë“œ ì´ë²¤íŠ¸ íƒˆì·¨)
        const menuInput = document.getElementById('menuName');
        if (menuInput) {
          menuInput.focus(); // 2. ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤
          menuInput.select(); // (Optional) í¸ì˜ë¥¼ ìœ„í•´ ì „ì²´ ì„ íƒ
        }
      }, 300); // 300ms delay to bypass initialization race conditions
    };

    // ğŸ”„ ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('syncNowBtn').onclick = () => {
      syncWithGas(false);
    };

    // ğŸ”„ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ë¡œì§ (GAS GET)
    async function syncWithGas(silent = false) {
      if (!GAS_WEB_APP_URL) return;

      const syncBtn = document.getElementById('syncNowBtn');
      const syncStatus = document.getElementById('syncStatus');
      const lastSyncTimeEl = document.getElementById('lastSyncTime');
      const assetCountEl = document.getElementById('assetCount');

      // ë¡œë”© ìƒíƒœ
      if (!silent) {
        syncBtn.disabled = true;
        syncBtn.textContent = 'â³ ë™ê¸°í™” ì¤‘...';
        syncStatus.textContent = 'ì—°ê²° ì¤‘...';
        syncStatus.style.color = 'var(--figma-color-text-secondary)';
      }

      try {
        const response = await fetch(GAS_WEB_APP_URL);
        if (!response.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        const parsedData = await response.json();

        // code.tsë¡œ ë°ì´í„° ì „ì†¡
        parent.postMessage({
          pluginMessage: {
            type: 'sync-external-db',
            data: parsedData
          }
        }, '*');

        // ì„±ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        lastSyncTimeEl.textContent = timeStr;
        assetCountEl.textContent = parsedData.length || 0;
        syncStatus.textContent = 'âœ… ì—°ê²°ë¨';
        syncStatus.style.color = 'var(--figma-color-text-success)';

        if (!silent) {
          syncBtn.textContent = 'âœ… ì™„ë£Œ!';
          setTimeout(() => {
            syncBtn.textContent = 'ğŸ”„ ì§€ê¸ˆ ë™ê¸°í™”';
            syncBtn.disabled = false;
          }, 2000);
        }

      } catch (error) {
        console.error('Sync failed:', error);

        syncStatus.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
        syncStatus.style.color = 'var(--figma-color-text-danger)';

        if (!silent) {
          syncBtn.textContent = 'âŒ ì¬ì‹œë„';
          syncBtn.disabled = false;
        }
      }
    }

    // Legacy Code Cleanup (Removed unused event listeners for removed elements)

    // CSV ë¼ì¸ íŒŒì„œ (ì´ì   ì‚¬ìš© ì•ˆí•˜ì§€ë§Œ í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ ë‚¨ê²¨ë‘ê±°ë‚˜ ì‚­ì œ ê°€ëŠ¥. ì‚­ì œí•¨)

    // CSV ë¼ì¸ íŒŒì„œ (ë”°ì˜´í‘œ í¬í•¨ ì²˜ë¦¬)
    function parseCSVLine(text) {
      const result = [];
      let curValue = '';
      let inQuote = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"') {
          inQuote = !inQuote;
        } else if (char === ',' && !inQuote) {
          result.push(curValue);
          curValue = '';
        } else {
          curValue += char;
        }
      }
      result.push(curValue);
      return result;
    }

    // í†µí•© ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
    onmessage = (event) => {
      const data = event.data.pluginMessage;
      const loading = document.getElementById("loadingIndicator");
      const resultsPre = document.getElementById("resultsPre");

      // ê¸°ë³¸ ì œì•ˆ ê¸°ëŠ¥ ë¡œë”© í•´ì œ
      if (data.type === "suggestions-result" || data.type === "suggestions-error") {
        suggestButton.disabled = false;
        loading.style.display = "none";
      }

      if (data.type === "suggestions-result") {
        renderKeywordFeedback(data.result);
        resultsPre.textContent = JSON.stringify(data.result, null, 2);
      } else if (data.type === "suggestions-error") {
        resultsPre.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${data.message}`;
        keywordFeedback.innerHTML = "";
      }

      // ğŸ†• ìƒˆë¡œìš´ ê¸°ëŠ¥ í•¸ë“¤ëŸ¬
      else if (data.type === 'component-set-info') {
        document.getElementById('regComponentSetName').value = data.data.name;
        document.getElementById('regComponentSetKey').value = data.data.key;

        const listContainer = document.getElementById('variantList');
        listContainer.innerHTML = ''; // ì´ˆê¸°í™”

        if (data.data.variants.length > 0) {
          data.data.variants.forEach((variant, index) => {
            // Variant ì†ì„±ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ (ì˜ˆ: "Type: Badge, State: Active")
            const labelText = Object.entries(variant)
              .map(([k, v]) => `${k}: ${v}`)
              .join(', ');

            // ì²´í¬ë°•ìŠ¤ ìš”ì†Œ ìƒì„±
            const itemDiv = document.createElement('div');
            itemDiv.className = 'fp-row';
            itemDiv.style.alignItems = 'center'; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
            itemDiv.style.gap = '8px';
            itemDiv.style.minHeight = '24px'; // í„°ì¹˜ ì˜ì—­ í™•ë³´

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `variant-${index}`;
            checkbox.checked = true; // ê¸°ë³¸ê°’: ì„ íƒë¨
            // ë°ì´í„° ì†ì„±ì— ì›ë³¸ ê°ì²´ ì €ì¥
            checkbox.dataset.variant = JSON.stringify(variant);

            const label = document.createElement('label');
            label.htmlFor = `variant-${index}`;
            label.textContent = labelText;
            label.style.fontSize = '11px';
            label.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥ í‘œì‹œ

            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(label);
            listContainer.appendChild(itemDiv);
          });
        } else {
          listContainer.innerHTML = '<span class="fp-sub">í‘œì‹œí•  Variantê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
        }

        // ì…ë ¥ í¼ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™ (íƒ€ì´í•‘ ëŠê¹€ ë°©ì§€) - ì œê±° (í”¼ê·¸ë§ˆ ìº”ë²„ìŠ¤ í¬ì»¤ìŠ¤ ê°„ì„­ ë°©ì§€)
        // setTimeout(() => {
        //   window.focus(); // í”ŒëŸ¬ê·¸ì¸ ì°½ í¬ì»¤ìŠ¤ ê°•ì œ
        //   const keywordInput = document.getElementById('regKeyword');
        //   if (keywordInput) keywordInput.focus();
        // }, 100);
      }

      else if (data.type === 'register-success') {
        alert(`âœ… "${data.keyword}" ì—ì…‹ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        document.getElementById('regKeyword').value = '';
        document.getElementById('regDescription').value = '';
        document.getElementById('regConcept').value = '';
      }


    };
  </script>
</body>

</html>